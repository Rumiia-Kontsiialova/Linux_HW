Post-Mortem: Восстановление сервера http://3.122.108.39/

Описание инцидента:

Дата: [02 апреля 2025]
Время возникновения проблемы: 09:25
Время полного восстановления: 14:55
Тип сбоя: Отсутствие конфигурационного файла + переполнение диска

Хронология событий:

09:25 Получено сообщение об ошибке на сервере http://3.122.108.39/.  

09:30 Проверка. Сервер не работает.
"SwgServer must be set in LocalSettings.php. See https://www.mediawiki.org/wiki/Manual:$wgServer."
делаем вывод, что-то с хранилищем и необходимо проверить файлик LocalSettings.php.

09:40 Обращение к системному администратору для получения приватного ключа, чтоб подключиться через терминал.

09:50 Ключ получен.
 
10:00 Проверка состояния сервера: service httpd status.

10:10 Попытка перезапуска сервера: service httpd start. Получена ошибка.

10:20 Поиск файла, указанного в ошибке на странице браузера: find / -type f -name "LocalSettings.php"  2>/dev/null.

10:30 Файл найден, просмотр через cat /var/www/html/mediawiki/LocalSettings.php.

10:35 Команда не возвращает результатов, а подсказка через Tab не срабатывает, что указывает на возможную нехватку оперативной памяти или недостаток места в системном разделе.

10:40 Проверка свободной памяти: free -h.

10:45 Корневой раздел заполнен на 100%.

10:50 Просмотр через vi /var/www/html/mediawiki/LocalSettings.php.

10:55 Файл LocalSettings.php пуст. 

11:00 Описание проблем с нехваткой памяти и пустым файлом системному администратору. Получена информация от системного администратора о наличии бэкапного файла с похожим названием.

11:20 Поиск бэкапного файла в /var/www/html/mediawiki/.

11:22 Обнаружен файл LoclSettings.php.

11:25 Попытка перезаписи cat. Ошибка: No such file or directory (из-за нехватки места).

11:30 Попытка копирования через cp, ошибка сохраняется.

11:35 Рассмотрен вариант удаления /tmp, но он весит мало. Удаление не имеет смысла.

12:00 Поиск всех файлов с ключевым словом Local: find / -name "*Local*" 2>/dev/null.

12:05 В разделе /home/ec2-user/ найден файл с ключевым словом.

12:10 В названии найденного файла присутствует синтаксическая ошибка. В запросе используются кавычки, чтоб система приняла содержимое как условие. 
Открыть файл: nano "/home/ec2-user/LocalSettings (5).php".

12:20 Файл выглядит как искомый бэкап.

12:25 Копирование невозможно из-за нехватки места.

12:30 Поиск больших файлов: find / -type f -size +50M 2>/dev/null.

12:40 Поиск файлов >100MB: find / -type f -size +100M -exec du -h {} + 2>/dev/null.

12:45 Найден locale-archive (108МБ).

12:50 Архив защищен, признак крайней важности. Принято решение заглянуть внутрь архива и взглянуть на содержимое: tar -t /usr/lib/locale/locale-archive. 

12:55 Получена ошибка. 

13:00 Запрос у администратора разрешения на использование следующих команд с sudo.

13:10 Разрешение одобрено. Выполнена команда find f -size +100M -exec du -h {} + 2>/dev/null с sudo.

13:15 Поиск с sudo: найден /var/log/httpd/access_log (7ГБ).

13:20 Файл содержит мусорные символы. Полное удаление опасно. Перезаписываем файл sudo echo "" > /var/log/httpd/access_log.
Важно не открывать файл через текстовый редактор - сервер может окончательно прекратить работу.

13:25 Получена ошибка "Permission denied".

13:30 Запрос разрешение на постоянное использование sudo в рамках текущей сессии, используя команду sudo su. 

13:35 Разрешение получено.

13:40 Выполнена команда в режиме модератора: find / -size +100M -exec du -h {} + 2>/dev/null.

13:45 Успешная попытка перезаписи файла.

13:50 Выходим из режима модератора exit.

13:55 Освобождено место: было заполнено 100%, стало 36%.

14:00 Проверка df -h, подтверждено улучшение. Стали доступны подсказки по tab.

14:05 Перезапись файла с синтаксической ошибкой, содержащий копию бэкапа. Копирование cp, указав полный путь к файлу с глобальными настройками.

14:10 Скопировано. Обновляем веб-станицу. Выдает ошибку.

14:15 Проверяем статус с помощью servise start. 

14:20 Проверка IP в конфигурации.

14:30 Обнаружена ошибка в скопированном файле. В переменной SwgServer указан 18.153.51.162. Меняем на 3.122.108.39.

14:35 Перезапуск httpd: sudo service httpd start.

14:40 Сервер восстановлен.

 
Причина сбоя:

Файл конфигурации LocalSettings.php был пуст.

Переполнен корневой раздел сервера (100%).

Невозможность скопировать файл из-за нехватки места.

Некорректный IP-адрес в переменной SwgServer.


Принятые меры:

✅ Очищен лог-файл /var/log/httpd/access_log (освободило 7ГБ).
✅ Восстановлен файл LocalSettings.php из бэкапа.
✅ Исправлен SwgServer в конфигурации.
✅ Перезапущен httpd.

Выполнил: Чумак Иван
Записала: Конциялова Румия
